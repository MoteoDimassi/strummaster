{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/dmitrij/Desktop/strummaster/src/features/audio/services/AudioEngineService.ts"],"sourcesContent":["import { StrumDirection, StrumType } from '../../../domain/entities';\nimport { PlaybackStrategyType } from '../../../shared/utils';\n\ndeclare global {\n  interface Window {\n    webkitAudioContext: typeof AudioContext;\n  }\n}\n\n// Chord Shapes (Fret positions: 6E, 5A, 4D, 3G, 2B, 1e)\nconst CHORD_FRETS: Record<string, (number | null)[]> = {\n  'Am': [null, 0, 2, 2, 1, 0], // X02210\n  'A':  [null, 0, 2, 2, 2, 0], // X02220\n  'C':  [null, 3, 2, 0, 1, 0], // X32010\n  'D':  [null, null, 0, 2, 3, 2], // XX0232\n  'Dm': [null, null, 0, 2, 3, 1], // XX0231\n  'E':  [0, 2, 2, 1, 0, 0], // 022100\n  'Em': [0, 2, 2, 0, 0, 0], // 022000\n  'G':  [3, 2, 0, 0, 0, 3], // 320003\n  'F':  [null, null, 3, 2, 1, 1], // XX3211\n};\n\nconst STRINGS = ['6E', '5A', '4D', '3G', '2B', '1e'];\n\nexport class AudioEngineService {\n  private playbackStrategy: PlaybackStrategyType = 'basic';\n  private audioContext: AudioContext | null = null;\n  private masterGainNode: GainNode | null = null;\n  private isInitialized: boolean = false;\n\n  private getAudioContext(): AudioContext {\n    if (!this.audioContext) {\n      const AudioContextClass = window.AudioContext || (window as any).webkitAudioContext;\n      if (!AudioContextClass) {\n        throw new Error('Web Audio API не поддерживается в этом браузере');\n      }\n      this.audioContext = new AudioContextClass();\n    }\n    return this.audioContext;\n  }\n\n  private getMasterGainNode(): GainNode {\n    if (!this.masterGainNode) {\n      const context = this.getAudioContext();\n      this.masterGainNode = context.createGain();\n      this.masterGainNode.connect(context.destination);\n      this.masterGainNode.gain.value = 0.5;\n    }\n    return this.masterGainNode;\n  }\n\n  private init() {\n    if (!this.isInitialized) {\n      this.getAudioContext();\n      this.getMasterGainNode();\n      this.isInitialized = true;\n    }\n  }\n\n  public get currentTime(): number {\n    this.init();\n    return this.getAudioContext().currentTime;\n  }\n\n  public async resume(): Promise<void> {\n    this.init();\n    await this.getAudioContext().resume();\n  }\n\n  public setVolume(val: number): void {\n    this.init();\n    this.getMasterGainNode().gain.value = val;\n  }\n\n  public setPlaybackStrategy(strategy: PlaybackStrategyType): void {\n    this.playbackStrategy = strategy;\n  }\n\n  public async preloadChord(chordName: string): Promise<void> {\n    this.init();\n    // Используем AudioSampleFactory для предварительной загрузки\n    const { audioSampleFactory } = await import('../../../shared/utils/AudioSampleFactory');\n    \n    \n    const frets = CHORD_FRETS[chordName];\n    if (frets) {\n      await audioSampleFactory.loadChordSamples(chordName, frets);\n    }\n  }\n\n  public async strum(\n    direction: StrumDirection,\n    chordName: string,\n    type: StrumType,\n    time?: number\n  ): Promise<void> {\n    this.init();\n    \n    // Импортируем зависимости динамически, чтобы избежать циклических зависимостей\n    const { audioSampleFactory } = await import('../../../shared/utils/AudioSampleFactory');\n    const { PlaybackStrategyFactory } = await import('../../../shared/utils/PlaybackStrategies');\n    \n    \n    // Ghost notes are silent\n    if (type === 'ghost') {\n      return;\n    }\n    \n    const startTime = time || this.getAudioContext().currentTime;\n    \n    try {\n      // Handle Mute Strum\n      if (type === 'mute') {\n        const muteSample = await audioSampleFactory.preloadMuteSample();\n        const strategy = PlaybackStrategyFactory.getMuteStrategy();\n        await strategy.play([muteSample], direction, type, this.getAudioContext(), this.getMasterGainNode(), startTime);\n        return;\n      }\n      \n      // Handle Normal Strum\n      const frets = CHORD_FRETS[chordName];\n      if (!frets) {\n        console.error(`Unknown chord: ${chordName}`);\n        return;\n      }\n      \n      const chordSample = await audioSampleFactory.loadChordSamples(chordName, frets);\n      const strategy = PlaybackStrategyFactory.getStrategy(this.playbackStrategy);\n      \n      await strategy.play(chordSample.samples, direction, type, this.getAudioContext(), this.getMasterGainNode(), startTime);\n      \n    } catch (error) {\n      console.error(`Failed to play strum:`, error);\n    }\n  }\n\n  public async playNote(stringName: string, fret: number, time?: number): Promise<void> {\n    this.init();\n    \n    // Импортируем зависимости динамически, чтобы избежать циклических зависимостей\n    const { audioSampleFactory } = await import('../../../shared/utils/AudioSampleFactory');\n    const { PlaybackStrategyFactory } = await import('../../../shared/utils/PlaybackStrategies');\n    \n    const startTime = time || this.getAudioContext().currentTime;\n    \n    try {\n      const sample = await audioSampleFactory.loadSample({\n        stringName,\n        fret\n      });\n      \n      if (!sample.buffer) {\n        throw new Error(`Sample not loaded: ${stringName}-${fret}`);\n      }\n      \n      const strategy = PlaybackStrategyFactory.getStrategy(this.playbackStrategy);\n      await strategy.play([sample], 'down', 'strum', this.getAudioContext(), this.getMasterGainNode(), startTime);\n      \n    } catch (error) {\n      console.error(`Failed to play note:`, error);\n    }\n  }\n\n  public registerActiveSource(source: any): void {\n    // Пустая реализация для совместимости\n  }\n\n  public stopAllSounds(): void {\n    this.init();\n    this.getMasterGainNode().gain.value = 0;\n  }\n\n  public stop(): void {\n    if (this.audioContext) {\n      this.audioContext.close();\n      this.audioContext = null;\n      this.masterGainNode = null;\n      this.isInitialized = false;\n    }\n  }\n\n  public getAvailableChords(): string[] {\n    return ['Am', 'A', 'C', 'D', 'Dm', 'E', 'Em', 'G', 'F'];\n  }\n\n  public getPlaybackStrategy(): PlaybackStrategyType {\n    return this.playbackStrategy;\n  }\n\n  public isAudioInitialized(): boolean {\n    return this.isInitialized;\n  }\n}\n\nexport const audioEngineService = new AudioEngineService();"],"names":[],"mappings":"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"}}]
}